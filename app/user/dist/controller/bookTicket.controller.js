sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,n,o){"use strict";var a;return e.extend("app.user.controller.bookTickets",{onInit:function(){var e=this;var n=this._loadTrainsData();var o=this._loadBookingsData();Promise.all([n,o]).then(function(n){var o=n[0];var a=n[1];o.forEach(function(e){var t=parseInt(e.seatingCapacity);var n=a.filter(function(t){return t.trainCode===e.trainCode}).reduce(function(e,t){return e+parseInt(t.noOfSeatsBooked)},0);e.availableSeats=t-n});var s=new t({entries:o});e.getView().setModel(s,"trainsModel");var i=e.getView().byId("trainsTable");i.setModel(s);i.bindItems({path:"trainsModel>/entries",template:new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{trainsModel>trainCode}"}),new sap.m.Text({text:"{trainsModel>trainName}"}),new sap.m.Text({text:"{trainsModel>sourceStation}"}),new sap.m.Text({text:"{trainsModel>destinationStation}"}),new sap.m.Text({text:"{trainsModel>ticketPrice}"}),new sap.m.Text({text:"{trainsModel>availableSeats}"}),new sap.m.Button({icon:"sap-icon://action",press:this.onBookTicketPress.bind(this)})]})})}.bind(this))},_loadTrainsData:function(){var e=this;return new Promise(function(t,n){var o=new sap.ui.model.json.JSONModel;e.getView().setModel(o,"trainsModel");let a=e.getOwnerComponent().getModel();let s=a.bindList("/Trains");s.requestContexts(0,Infinity).then(function(e){var n=[];e.forEach(function(e){n.push(e.getObject())});t(n)})})},_loadBookingsData:function(){var e=this;return new Promise(function(t,n){var o=new sap.ui.model.json.JSONModel;e.getView().setModel(o,"bookingsModel");let a=e.getOwnerComponent().getModel();let s=a.bindList("/Bookings");s.requestContexts(0,Infinity).then(function(e){var n=[];e.forEach(function(e){n.push(e.getObject())});t(n)})})},onBookTicketPress:function(e){var t=e.getSource().getParent();var n=t.getBindingContext("trainsModel");a=n.getObject();console.log("Selected Train:",a);var o=this.getView().byId("_IDGenPanel2");o.setVisible(true);var s=sap.ui.getCore().getModel("loggedInUser");if(s){var i=s.getProperty("/username");this.byId("username").setValue(i)}},onBookTicketsPress:function(){var e=this;const t=this.byId("username").getValue();const n=this.byId("numSeats").getValue();if(n>a.availableSeats){sap.m.MessageToast.show("Number of seats available is less than your request",{duration:3e3,width:"15em",my:"center top",at:"center top",of:window,offset:"30 30",onClose:function(){console.log("Message toast closed")}});return}else if(t===""){sap.m.MessageToast.show("Enter Username",{duration:3e3,width:"15em",my:"center top",at:"center top",of:window,offset:"30 30",onClose:function(){console.log("Message toast closed")}});return}else if(n<=0){sap.m.MessageToast.show("Number of seats cannot be zero (0)",{duration:3e3,width:"15em",my:"center top",at:"center top",of:window,offset:"30 30",onClose:function(){console.log("Message toast closed")}});return}else{var o={id:Math.round(Math.random()*100),uid:108,username:t,trainCode:parseInt(a.trainCode),trainName:a.trainName,noOfSeatsBooked:parseInt(n),sourceStation:a.sourceStation,destinationStation:a.destinationStation};let e=this.getView().getModel();let s=e.bindList("/Bookings");s.create(o);sap.m.MessageToast.show("Successfully Booked your tickets",{duration:3e3,width:"15em",my:"center top",at:"center top",of:window,offset:"30 30",onClose:function(){console.log("Message toast closed")}});const i=this.getOwnerComponent().getRouter();i.navTo("Routehome")}},onFilterTrains:function(){var e=this.getView();var t=e.byId("fromStation").getValue();var a=e.byId("toStation").getValue();var s=e.byId("trainName1").getValue();var i=e.byId("classSegmentedButton").getSelectedKey();var r=[];if(t){r.push(new n("sourceStation",o.Contains,t))}if(a){r.push(new n("destinationStation",o.Contains,a))}if(s){r.push(new n("trainName",o.Contains,s))}if(i){r.push(new n("class",o.EQ,i))}var l=e.byId("trainsTable");var d=l.getBinding("items");d.filter(r)}})});
//# sourceMappingURL=bookTicket.controller.js.map